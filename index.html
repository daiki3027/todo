<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TODO</title>
  <style>
    :root{
      --bg:#f6f8ff; --panel:#fff; --line:#e6e9f3;
      --text:#222; --muted:#667; --accent:#4a90e2; --danger:#e74c3c;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font:16px/1.6 system-ui, sans-serif; color:var(--text);
      background:linear-gradient(180deg,#fff,#f6f8ff 60%, #eef2fb);
      min-height:100dvh; display:grid; place-items:start center;
    }
    .app{ width:min(760px,94%); margin:48px auto; }
    .card{
      background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:18px;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
    }
    h1{ margin:0 0 12px; font-size:22px }
    .badge{ margin-left:.6rem; font-size:12px; color:var(--muted);
      border:1px solid var(--line); padding:2px 8px; border-radius:999px; }

    .row{ display:flex; gap:10px; margin:8px 0 10px }
    .input{ flex:1; padding:10px 12px; border:1px solid var(--line); border-radius:8px; outline:none; }
    .input:focus{ border-color:var(--accent); box-shadow:0 0 0 2px rgba(74,144,226,.25) }
    .btn{ border:0; cursor:pointer; padding:10px 14px; border-radius:8px; font-weight:600; background:var(--accent); color:#fff; }

    ul{ list-style:none; margin:0; padding:0 }
    li{ display:flex; align-items:center; gap:10px; background:#fafbff; border:1px solid var(--line);
        padding:10px; border-radius:8px; margin:6px 0; }
    li input[type="checkbox"]{ width:18px; height:18px }
    .title.done{ text-decoration:line-through; color:var(--muted) }
    .spacer{ flex:1 }
    .del{ border:0; cursor:pointer; padding:6px 10px; border-radius:6px; background:var(--danger); color:#fff; font-weight:600; }

    .hint{ color:var(--muted); font-size:12px; margin-top:6px; text-align:right }
    @media (max-width:560px){ .row{ flex-direction:column } }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <h1>TODOアプリ<span class="badge">Vanilla JS</span></h1>

      <div class="row">
        <input id="todoInput" class="input" type="text" placeholder="やることを入力" />
        <button id="addBtn" class="btn">追加</button>
      </div>

      <ul id="todoList"></ul>
      <div class="hint">Enterで追加 / チェックで完了 / 削除で削除（保存先: PostgreSQL）</div>
    </div>
  </div>

  <template id="item-tmpl">
    <li>
      <input type="checkbox" class="toggle">
      <span class="title"></span>
      <span class="spacer"></span>
      <button class="del">削除</button>
    </li>
  </template>

  <script>
    // 要素参照
    const todoListEl = document.getElementById('todoList');
    const todoInputEl = document.getElementById('todoInput');
    const addBtn = document.getElementById('addBtn');

    // JSONを送受信する小さなユーティリティ
    async function requestJson(url, options) {
      const res = await fetch(url, { headers: { 'Content-Type': 'application/json' }, ...options });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    // 一覧を読み込んで表示
    async function loadTodos() {
      const items = await requestJson('/api/todos');
      todoListEl.innerHTML = '';
      for (const it of items) appendTodoItemRow(it);
    }

    // 1件分の行をテンプレートから作り、リストに追加
    function appendTodoItemRow(item) {
      const node = document.getElementById('item-tmpl').content.firstElementChild.cloneNode(true);
      node.dataset.id = item.id;
      const titleEl = node.querySelector('.title');
      const toggleEl = node.querySelector('.toggle');
      const delBtn = node.querySelector('.del');

      titleEl.textContent = item.title;
      toggleEl.checked = !!item.completed;
      titleEl.classList.toggle('done', !!item.completed);

      toggleEl.addEventListener('change', async () => {
        const updated = await requestJson('/api/todos/' + item.id, {
          method: 'PUT',
          body: JSON.stringify({ completed: toggleEl.checked })
        });
        titleEl.classList.toggle('done', !!updated.completed);
      });

      delBtn.addEventListener('click', async () => {
        if (!confirm('削除しますか？')) return;
        await requestJson('/api/todos/' + item.id, { method: 'DELETE' });
        node.remove();
      });

      todoListEl.appendChild(node);
    }

    // 入力欄から作成→リストに追加
    async function createTodoFromInputAndAppend() {
      const title = todoInputEl.value.trim();
      if (!title) return;
      const created = await requestJson('/api/todos', { method: 'POST', body: JSON.stringify({ title }) });
      appendTodoItemRow(created);
      todoInputEl.value = '';
      todoInputEl.focus();
    }

    // イベント: クリック/Enterで追加
    addBtn.addEventListener('click', createTodoFromInputAndAppend);
    todoInputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        createTodoFromInputAndAppend();
      }
    });

    // 初期表示
    loadTodos().catch((e) => console.error(e));
  </script>
</body>
</html>
